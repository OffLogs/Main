node('production') {
    env.TAG_WEB_IMAGE = "offlogs-production-web"
    env.TAG_FRONTEND_WEB_IMAGE = "offlogs-production-front"

    stage('Checkout') {
        checkout scm
    }
    
    stage('Build Web image') {
        sh 'docker build --tag=$TAG_WEB_IMAGE --label=$TAG_WEB_IMAGE --file="devops/publish/web/Dockerfile" .'
    }
    
    stage('Build Frontend image') {
        sh 'docker build --tag=$TAG_FRONTEND_WEB_IMAGE --label=$TAG_FRONTEND_WEB_IMAGE --file="devops/publish/front/Dockerfile" .'
    }
    
    stage('Stop exists containers') {
        sh 'docker stop $TAG_WEB_IMAGE || true && docker rm $TAG_WEB_IMAGE || true'
        sh 'docker stop $TAG_FRONTEND_WEB_IMAGE || true && docker rm $TAG_FRONTEND_WEB_IMAGE || true'
    }
    
    stage('Run images') {
        sh '''
            if [ ! "$(docker ps -q -f name=$TAG_WEB_IMAGE)" ]; then
                if [ "$(docker ps -aq -f status=exited -f name=$TAG_WEB_IMAGE)" ]; then
                    # cleanup
                    docker rm $TAG_WEB_IMAGE
                fi
            fi
        '''
        sh 'docker run --detach --restart=always --name=$TAG_WEB_IMAGE $TAG_WEB_IMAGE'
        sh '''
            if [ ! "$(docker ps -q -f name=$TAG_FRONTEND_WEB_IMAGE)" ]; then
                if [ "$(docker ps -aq -f status=exited -f name=$TAG_FRONTEND_WEB_IMAGE)" ]; then
                    # cleanup
                    docker rm $TAG_FRONTEND_WEB_IMAGE
                fi
            fi
        '''
        sh 'docker run --detach --restart=always --name=$TAG_FRONTEND_WEB_IMAGE $TAG_FRONTEND_WEB_IMAGE'
    }
}
