node('production') {
    env.TAG_WEB_IMAGE = "offlogs-production-web"
    env.TAG_FRONTEND_WEB_IMAGE = "offlogs-production-front"

    properties([
        disableConcurrentBuilds()
    ])

    stage('Checkout') {
        checkout scm
    }
    
    stage('Stop exists containers') {
        sh '''
            if [ "$(docker ps -aq -f status=restarting -f status=running -f status=removing -f status=paused -f name=$TAG_WEB_IMAGE)" ]; then
                docker container stop $TAG_WEB_IMAGE
            fi
            if [ "$(docker ps -aq -f status=exited -f status=dead -f name=$TAG_WEB_IMAGE)" ]; then
                docker container rm $TAG_WEB_IMAGE
            fi
        '''
        sh '''
            if [ "$(docker ps -aq -f status=restarting -f status=running -f status=removing -f status=paused -f name=$TAG_FRONTEND_WEB_IMAGE)" ]; then
                docker container stop $TAG_FRONTEND_WEB_IMAGE
            fi
            if [ "$(docker ps -aq -f status=exited -f status=dead -f name=$TAG_FRONTEND_WEB_IMAGE)" ]; then
                docker container rm $TAG_FRONTEND_WEB_IMAGE
            fi
        '''
    }
    
    stage('Build Web image') {
        sh 'docker build --tag=$TAG_WEB_IMAGE --label=$TAG_WEB_IMAGE --file="devops/publish/web/Dockerfile" .'
    }
    
    stage('Build Frontend image') {
        sh 'docker build --tag=$TAG_FRONTEND_WEB_IMAGE --label=$TAG_FRONTEND_WEB_IMAGE --file="devops/publish/front/Dockerfile" .'
    }
    
    stage('Run images') {
        sh 'docker run --detach --restart=always --name=$TAG_WEB_IMAGE $TAG_WEB_IMAGE'
        sh 'docker run --detach --restart=always --name=$TAG_FRONTEND_WEB_IMAGE $TAG_FRONTEND_WEB_IMAGE'
    }
}
